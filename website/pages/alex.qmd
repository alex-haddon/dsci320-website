---
title: "Temporal Trends in Traffic Stops"
author: "Alex Haddon"
page-layout: full
toc: false
---

#### AQ1: *How does the frequency of traffic stops vary throughout the day, and are there consistent “peak” or “low” hours in 2005 versus 2015?*

### Exploring General Hourly Patterns in Traffic Stops with Yearly Comparison and Time-Period Summaries

```{python}
#| echo: false
#| message: false
#| warning: false
#| fig-cap: "View 1"
import pandas as pd
import altair as alt
import numpy as np

alt.data_transformers.enable("vegafusion")

nc_data = pd.read_csv("../../data/processed/processed_nc_charlotte_2005_2015.csv", parse_dates=["datetime"])

#data transformation
nc_data['year'] = nc_data['datetime'].dt.year
nc_data['month'] = nc_data['datetime'].dt.month
nc_data['day'] = nc_data['datetime'].dt.day
nc_data['day_of_week'] = nc_data['datetime'].dt.day_name()
nc_data['hour'] = nc_data['datetime'].dt.hour
nc_data['minute'] = nc_data['datetime'].dt.minute

stops_per_day_hour_year = (nc_data.groupby(['year', 'date', 'hour']).size().reset_index(name='stops'))
mean_stops_per_hour_year = (stops_per_day_hour_year.groupby(['year', 'hour'])['stops'].mean().reset_index(name='mean_stops'))
mean_stops_per_hour_overall = (mean_stops_per_hour_year.groupby('hour')['mean_stops'].mean().reset_index(name='mean_stops'))
mean_stops_per_hour_overall['year'] = 'All'

# Combine for plotting
plot_data = pd.concat([mean_stops_per_hour_year[['year', 'hour', 'mean_stops']], mean_stops_per_hour_overall[['year', 'hour', 'mean_stops']]])
plot_data['year'] = plot_data['year'].astype(str)

# Create a selection that chooses the nearest point & selects based on x-value
nearest = alt.selection_point(nearest=True, on="pointerover", fields=["hour"], empty=False)

time_period_sel = alt.selection_point(name='time_period_click', fields=['time_period'], empty=True, on='click')

lines = alt.Chart(plot_data).mark_line().encode(
    x=alt.X("hour:Q", title="Hour of Day", axis=alt.Axis(tickCount=24)),
    y=alt.Y("mean_stops:Q", title="Mean Number of Stops"),
    color=alt.Color("year:N", title="Year"),
    tooltip=[
        alt.Tooltip('mean_stops:Q', title='Average Stops', format='.2f'),
        alt.Tooltip('hour:O', title='Hour'),
        alt.Tooltip('year:N', title='Year')]
)

background = alt.Chart(alt.Data(values=[
    {'hour_start': 0, 'hour_end': 6, 'time_period': 'Early Morning'},
    {'hour_start': 6, 'hour_end': 12, 'time_period': 'Morning'},
    {'hour_start': 12, 'hour_end': 18, 'time_period': 'Afternoon'},
    {'hour_start': 18, 'hour_end': 24, 'time_period': 'Evening'}
])).mark_rect(color='lightblue').encode(
    x=alt.X('hour_start:Q'),
    x2='hour_end:Q',
    opacity=alt.when(time_period_sel).then(alt.value(0.4)).otherwise(alt.value(0))
).transform_filter(
    time_period_sel
)

# Transparent selectors across the chart. This is what tells the x-value of the cursor
selectors = alt.Chart(plot_data).mark_point().encode(
    x="hour:Q",
    opacity=alt.value(0),
).add_params(
    nearest
)

when_near = alt.when(nearest)

#draw pointss
points = lines.mark_point(filled=True).encode(
    opacity=when_near.then(alt.value(1)).otherwise(alt.value(0))
)

rules = alt.Chart(plot_data).mark_rule(color="gray").encode(
    x="hour:Q",
).transform_filter(
    nearest
)

# Combine layers
chart1 = alt.layer(background, lines, selectors, points, rules
).add_params(time_period_sel).properties(
    title="Average Number of Traffic Stops by Hour of Day",
    width=900,
    height=180
)


violin = alt.Chart(stops_per_day_hour_year).transform_filter(
    (nearest)
).transform_density(
    'stops',
    as_=['stops','density'],
    groupby=['year']
).mark_area(orient='horizontal', opacity=0.8).encode(
    y=alt.Y('stops:Q', title='Stops per Day'),
    x=alt.X('density:Q', stack='center', title=None).axis(labels=False),
    color=alt.Color('year:N', title='Year'),
    column=alt.Column('year:N', title='Year').spacing(0).header(titleOrient='bottom', labelOrient='bottom', labelPadding=0),
    tooltip=[alt.Tooltip('stops:Q', title="Stops"),
            alt.Tooltip('density:Q', title="Density", format=".2f")]
).properties(
    title='Density of Stops in Selected Hour',
    width=100,
    height=180
)

hour_text = (alt.Chart(plot_data).mark_text(
        baseline='middle',
        align='center',
        fontSize=25,
        fontWeight='bold',
        opacity=0.5
    ).transform_filter(nearest).transform_aggregate(hour='max(hour)').transform_calculate(hour_label="'Hour: ' + toString(datum.hour)"
    ).encode(text='hour_label:N').properties(width=50, height=50)
)

time_period_chart = alt.Chart(plot_data).transform_calculate(
    time_period=alt.expr.if_(
        alt.datum.hour < 6, 'Early Morning',
        alt.expr.if_(
            alt.datum.hour < 12, 'Morning',
            alt.expr.if_(
                alt.datum.hour < 18, 'Afternoon',
                'Evening'))),
    time_period_full=alt.expr.if_(
        alt.datum.hour < 6, 'Early Morning (12am-6am)',
        alt.expr.if_(alt.datum.hour < 12, 'Morning (6am-12pm)',
            alt.expr.if_(alt.datum.hour < 18, 'Afternoon (12pm-6pm)',
                        'Evening (6pm-12am)')))
).mark_bar(color='#d62728').encode(
    x=alt.X('time_period:N', title='Time Period', axis=alt.Axis(labelAngle=0),
            sort=['Early Morning', 'Morning', 'Afternoon', 'Evening']),
    y=alt.Y('sum(mean_stops):Q', title='Sum of Average Stops'),
    tooltip=[
        alt.Tooltip('sum(mean_stops):Q', title='Mean Stops', format='.0f'),
        alt.Tooltip('time_period_full:N', title='Time Period')]
).properties(
    title='Sum of Mean Stops by Time Period',
    width=300,
    height=180
).add_params(time_period_sel)

time_period_chart


view1 = (chart1 & (hour_text | violin | time_period_chart).resolve_legend(color='independent')).resolve_legend(color='independent'
).resolve_scale(color='independent'
).configure_view(stroke=None)

view1
```

#### AQ2: *Are specific combinations of temporal factors (ex: Friday nights, winter mornings) associated with particular types of violations?*

### Temporal Patterns of Police Stops by Reason, Day of the Week, Season, and Hour

```{python}
#| echo: false
#| message: false
#| warning: false
#| fig-cap: "View 2"
import pandas as pd
import altair as alt
import numpy as np

alt.data_transformers.enable("vegafusion")

nc_data = pd.read_csv("../../data/processed/processed_nc_charlotte_2005_2015.csv", parse_dates=["datetime"])

# Are specific combinations of temporal factors (ex: Friday nights, winter mornings) 
# associated with particular types of violations or enforcement behaviors?

nc_data['year'] = nc_data['datetime'].dt.year
nc_data['month'] = nc_data['datetime'].dt.month
nc_data['day'] = nc_data['datetime'].dt.day
nc_data['day_of_week'] = nc_data['datetime'].dt.day_name()
nc_data['hour'] = nc_data['datetime'].dt.hour
nc_data['minute'] = nc_data['datetime'].dt.minute

# Create season based on month
def get_season(month):
    if month in [12, 1, 2]:
        return 'Winter'
    elif month in [3, 4, 5]:
        return 'Spring'
    elif month in [6, 7, 8]:
        return 'Summer'
    else:
        return 'Fall'

nc_data['season'] = nc_data['month'].apply(get_season)

grouped = nc_data.groupby(['year', 'season', 'day_of_week', 'reason_for_stop']).size().reset_index(name="violation_count")
grouped['year'] = grouped['year'].astype(str)

# Create "All years" aggregation
all_years = nc_data.groupby(['season', 'day_of_week', 'reason_for_stop']).size().reset_index(name="violation_count")
all_years['year'] = 'All'


# Combine and reorder
violation_by_day_season = pd.concat([grouped, all_years], ignore_index=True)

years = ['2005', '2015', 'All']
seasons = ['Winter', 'Spring', 'Summer', 'Fall']
days_of_week = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
reasons = violation_by_day_season['reason_for_stop'].unique()

# Create multi-index with all combinations
complete_index = pd.MultiIndex.from_product(
    [years, seasons, days_of_week, reasons],
    names=['year', 'season', 'day_of_week', 'reason_for_stop']
)

# Reindex to include all combinations, filling missing values with 0
violation_by_day_season = (
    violation_by_day_season
    .set_index(['year', 'season', 'day_of_week', 'reason_for_stop'])
    .reindex(complete_index, fill_value=0)
    .reset_index()
)

year_reason_totals = violation_by_day_season.groupby(['year', 'reason_for_stop'])['violation_count'].transform('sum')

# Calculate percentage
violation_by_day_season['percentage'] = (violation_by_day_season['violation_count'] / year_reason_totals * 100)

violation_by_day_season['percentage'] = violation_by_day_season['percentage'].fillna(0)
violation_by_day_season = violation_by_day_season[['year', 'season', 'day_of_week', 'reason_for_stop', 'violation_count', 'percentage']]

#Viz start

# dropdown for reason_for_stop
reason_dropdown = alt.binding_select(
    options= sorted(violation_by_day_season['reason_for_stop'].unique().tolist()),
    name='Reason for Stop: '
)
reason_selection = alt.selection_point(
    fields=['reason_for_stop'],
    bind=reason_dropdown,
    value=[{'reason_for_stop': violation_by_day_season['reason_for_stop'].iloc[0]}]
)

#yr dropdown
year_dropdown = alt.binding_select(
    options=sorted(violation_by_day_season['year'].unique().tolist()),
    name='Year: '
)
year_selection = alt.selection_point(
    fields=['year'],
    bind=year_dropdown,
    value=[{'year': 'All'}]
)


day_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
season_order = ['Winter', 'Spring', 'Summer', 'Fall']

#brush
brush = alt.selection_point(fields=['season', 'day_of_week'])

#heatmap
heatmap = alt.Chart(violation_by_day_season).mark_rect().encode(
    x=alt.X('day_of_week:N', 
            title='Day of Week',
            sort=day_order),
    y=alt.Y('season:N', 
            title='Season',
            sort=season_order),
    color=alt.Color('percentage:Q',
                    title='Percentage (%)',
                    scale=alt.Scale(scheme='viridis')),
    opacity=alt.condition(brush, alt.value(1.0), alt.value(0.3)),
    tooltip=[
        alt.Tooltip('reason_for_stop:N', title='Reason'),
        alt.Tooltip('violation_count:Q', title='Count'),
        alt.Tooltip('percentage:Q', title='Percentage (%)', format='.2f')
    ]
).add_params(
    reason_selection,
    year_selection,
    brush
).transform_filter(
    reason_selection
).transform_filter(
    year_selection
).properties(
    width=500,
    height=400,
    title='Selected Violation Distribution by Day of Week and Season'
)

# hourly manipulation
hourly_data = nc_data.groupby(['year', 'season', 'day_of_week', 'reason_for_stop', 'hour']).size().reset_index(name='count')
hourly_data['year'] = hourly_data['year'].astype(str)

hourly_all = nc_data.groupby(['season', 'day_of_week', 'reason_for_stop', 'hour']).size().reset_index(name='count')
hourly_all['year'] = 'All'

hourly_combined = pd.concat([hourly_data, hourly_all], ignore_index=True)

# bar chart
bar_chart = alt.Chart(hourly_combined).mark_bar(color='#1f77b4').encode(
    x=alt.X('hour:O', 
            title='Hour of Day',
            axis=alt.Axis(labelAngle=0)),
    y=alt.Y('sum(count):Q', 
            title='Number of Violations'),
    tooltip=[
        alt.Tooltip('sum(count):Q', title='Total Violations')
    ]
).add_params(
    reason_selection,
    year_selection
).transform_filter(
    reason_selection
).transform_filter(
    year_selection
).transform_filter(
    brush
).properties(
    width=400,
    height=400,
    title='Hourly Violation Distribution for Selected Reason'
)

# 
violation_totals = nc_data.groupby(['year', 'reason_for_stop']).size().reset_index(name='total_count')
violation_totals['year'] = violation_totals['year'].astype(str)

violation_all = nc_data.groupby(['reason_for_stop']).size().reset_index(name='total_count')
violation_all['year'] = 'All'

violation_breakdown_full = pd.concat([violation_totals, violation_all], ignore_index=True)

# all year/reason combinations
all_years = violation_breakdown_full['year'].unique()
all_reasons = violation_breakdown_full['reason_for_stop'].unique()

# create both usable reason vs other
comparison_data = []
for yr in all_years:
    year_total = violation_breakdown_full[violation_breakdown_full['year'] == yr]['total_count'].sum()
    for reason in all_reasons:
        selected_count = violation_breakdown_full[
            (violation_breakdown_full['year'] == yr) & 
            (violation_breakdown_full['reason_for_stop'] == reason)
        ]['total_count'].sum()
        other_count = year_total - selected_count
        
        comparison_data.append({
            'year': yr,
            'reason_for_stop': reason,
            'category': 'Selected Reason',
            'display_reason': reason,
            'count': selected_count,
            'percentage': selected_count / year_total if year_total > 0 else 0,
            'sort_order': 0
        })
        comparison_data.append({
            'year': yr,
            'reason_for_stop': reason,
            'category': 'All Other Reasons',
            'display_reason': 'Other',
            'count': other_count,
            'percentage': other_count / year_total if year_total > 0 else 0,
            'sort_order': 1
        })

comparison_df = pd.DataFrame(comparison_data)

# Create comparison chart with pre-calculated fields
breakdown_chart = alt.Chart(comparison_df).mark_bar().encode(
    x=alt.X('count:Q',
            title='Percentage of Total Stops',
            stack='normalize',
            axis=alt.Axis(format='%')),
    y=alt.Y('year:N', 
            title="Year"),
    color=alt.Color('legend_category:N',
                    title='Violation',
                    scale=alt.Scale(domain=['Selected Reason', 'Other'],
                                  range=['#1f77b4', '#cccccc'])),
    order=alt.Order('sort_order:Q'),
    tooltip=[
        alt.Tooltip('year:N', title='Year'),
        alt.Tooltip('display_reason:N', title='Reason'),
        alt.Tooltip('percentage:Q', title='Percentage', format='.2%')
    ]
).add_params(
    year_selection,
    reason_selection
).transform_filter(
    year_selection
).transform_filter(
    reason_selection
).transform_calculate(
    legend_category="datum.category === 'Selected Reason' ? 'Selected Reason' : 'Other'"
).properties(
    width=1000,
    height=75,
    title='Selected Reason vs All Other Violations'
)

top_row = (heatmap | bar_chart).resolve_legend(color='independent')
view2 = (top_row & breakdown_chart).resolve_legend(color='independent')

view2
```

#### AQ3: *Are certain types of traffic stop outcomes common at specific times of day?*

### Patterns in Traffic Stop Outcomes by Time of Day

```{python}
#| echo: false
#| message: false
#| warning: false
#| fig-cap: "View 3"
import pandas as pd
import altair as alt
import numpy as np

alt.data_transformers.enable("vegafusion")

nc_data = pd.read_csv("../../data/processed/processed_nc_charlotte_2005_2015.csv", parse_dates=["datetime"])
nc_data['year'] = nc_data['datetime'].dt.year
nc_data['time'] = pd.to_datetime(nc_data['time'], format='%H:%M:%S', errors='coerce')
plot_data = nc_data[['time', 'outcome', 'year']].dropna()

# Add a random value for sampling
plot_data['random'] = np.random.random(len(plot_data))

# Nicer names for actions
outcome_mapping = {
    'citation': 'Citation',
    'warning': 'Warning',
    'arrest': 'Arrest',
    'no action': 'No Action',}

plot_data['outcome'] = plot_data['outcome'].map(outcome_mapping)

# Selection
brush = alt.selection_interval(encodings=['x'], name='time_brush')
outcome_select = alt.selection_point(fields=['outcome'], name='outcome_click')

# Radio Button for year
year_radio = alt.binding_radio(
    options=[2005, 2015],
    labels=['2005', '2015'],
    name='Year: '
)
year_selection = alt.selection_point(fields=['year'], bind=year_radio, value=[{'year': 2005}])

# Slider for sample size using param
sample_param = alt.param(
    name='sample_threshold',
    value=1,
    bind=alt.binding_range(min=0.1, max=1, step=0.1, name='Proportion of Population Sampled: ')
)

color_scale = alt.Color('outcome:N', 
                        title='Outcome',
                        legend=alt.Legend(orient='right'))

# plot1
jitter = alt.Chart(plot_data).mark_circle(size=10, opacity=0.2).encode(
    x=alt.X("hoursminutes(time):T", title="Time of Day").scale(nice=True),
    y=alt.Y("outcome:N", title="Outcome"),
    yOffset="jitter:Q",
    color=color_scale,
    opacity=alt.condition(outcome_select, alt.value(0.8), alt.value(0.1)),
    tooltip=[alt.Tooltip('hoursminutes(time):T', title="Time of Day")]
).transform_calculate(
    jitter="sqrt(-2*log(random()))*cos(2*PI*random())"
).transform_filter(
    year_selection
).transform_filter(
    alt.datum.random < sample_param
).add_params(
    brush,
    outcome_select,
    year_selection,
    sample_param
).properties(
    width=500,
    height=350,
    title="Traffic Stop Outcome by Time of Day (Sampled)"
)

# plot2
bar = alt.Chart(plot_data).transform_filter(
    year_selection,
    alt.datum.random < sample_param
).transform_filter(
    brush
).transform_aggregate(
    count='count()',
    groupby=['outcome']
).transform_joinaggregate(
    total='sum(count)'
).transform_calculate(
    percentage='datum.count / datum.total * 100'
).mark_bar().encode(
    x=alt.X('outcome:N', title='Outcome', axis=alt.Axis(labelAngle=-45)),
    y=alt.Y('percentage:Q', title='Percentage (%)', scale=alt.Scale(domain=[0, 100])),
    color=color_scale,
    opacity=alt.condition(outcome_select, alt.value(1.0), alt.value(0.4)),
    tooltip=[
        alt.Tooltip('percentage:Q', title='Percentage', format='.1f'),
        alt.Tooltip('count:Q', title='Count')
    ]
).add_params(
    outcome_select,
    sample_param
).properties(
    width=200,
    height=400,
    title="Outcome Distribution (In Selected Time Range)"
)

view3 = jitter | bar

view3
```